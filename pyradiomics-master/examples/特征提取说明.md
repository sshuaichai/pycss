特征提取：
!!!注意：如果包在終端中安裝不成功，試試在conda中激活环境后，使用conda安装。
# 为了提高特征提取的准确性和可重复性，需要对MR图像进行预处理，如去噪、强度标准化、重采样等。

 ！运行地址：

# 首先，对所有进行重采样，後續参数文件就可以不用再定义重采样
### 对于可视化仍然可以选择在原图像上可视化，重采样只是为了提取的特征更加精准！可视化的特征虽然没有对图像进行重采样，但也反映了全局变量。
 #### 如果某个病人可视化遇到问题，可能和重采样有关，就换个病人可视化。
[helloFeatureClass_user.py]提取所有特征（包括所有要素类和内置的可选过滤器），但不进行重采样、归一化等操作。
使用一般要素类特征和内置的可选过滤器（如高斯拉普拉斯算子（LoG）和小波等所有特征，
enableAllFeatures()方法启用了所有可用的特征提取，包括基于原始图像、LoG滤波后的图像和小波变换后的图像的特征来对图像进行提取特征。[helloFeatureClass.py]仅指定了部分要素和LoG和小波处理的一阶特征，_user是升级版。
 可以先用[helloResampling.py]重采样后所有的图形后，得到相同的像素间距和尺寸、相同的空间分辨率和空间方向（特别对于多模态数据），然后再采用[helloFeatureClass_user.py]提取所有特征.
输入重采样后的图像和标签
`resampled_images`
`resampled_masks`

用重采样图像进行下列操作：
------------------------------------------------------------------------
# 注意：如果定義的參數有重采樣，就不用再用重采樣的圖像，重采樣的圖像是爲了体素特征提取方便/直接在体素参数中定义相同的重采样！！！

# 1.手动调参法（调参方便；但不同参数的提取特征数不同，可要素特征/要素+过滤特征；更加精准）（推荐）
# 1.1使用[GenerateInputCSV_Filename_user.py]生成数据的csv文件
`bin\[GenerateInputCSV_Filename_user.py] / bin\[GenerateInputCSV_Filename_userMRI.py]`
生成的xx.csv文件包括了image、label的文件地址, 
csv文件直接位于`examples\output`目录下。
或者
`GenerateInputCSV_Filename_userMRI.py生成的xx_MRI.csv尝试从文件名中提取序列和阅读者信息，
然后将这些信息一起写入到CSV文件中。


# 1.2参数设置
是否进行CT归一化？：[Extract_NIfTI_image_information.py](..%2Fradiomics%2Fdata_Conversion_and_extraction%2FExtract_NIfTI_image_information.py)
例如：
根据您提供的图像统计信息，我们可以看到图像的最小值和最大值在不同图像之间有很大的变化。
特别是，最小值在 -3024.0 到 -1024.0 之间变化，而最大值则在 1451.0 到 3071.0 甚至更高（如 15214.0 和 17901.0）。
这表明图像的强度范围在不同图像之间存在显著差异，这可能是由于不同的扫描参数或扫描仪导致的。


# 1.3[batchprocessing.py]提取指定参数的特征，每个参数提取的特征不同（包括是否采用归一化、重采样、一阶特征特定设置、不同的sigma值对于不同层厚等）
使用example里面提供的函数进行批处理，可指定SETTING里面的参数文件，默认为`Params.yaml（仅包含了要素类特征，没有应用过滤器等特征；并且无重采样！）`,
可根据CT/MR的需要更改参数，加入LOG和小波特征,`！！！注意：CT、MR需要进行重采样！默认是无重采样的！`这会对提取的特征准确性产生影响！！！
`这里出现（._la_029.nii.gz），这通常是macOS系统用来存储文件附加信息的隐藏文件，删掉后重新运行步骤1.生成csv文件再提取特征即可。`
再次运行[batchprocessing.py]定义参数批处理。
```
输入CSV文件Task02_Heart.csv
使用指定参数Params.yaml（无重采样！不行！）需要根据图像和需要提取的特征类型更换参数！！！/在预处理时对图像进行重采样
进度日志文件pyrad_log.txt
输出CSV文件radiomics_features.csv
```

# 具体见肺癌特征提取！！！！

# 1.4体素特征提取
根据特征提取参数定义的重采样方式来加入[exampleVoxel.yaml]函數中即可，輸出提取的体素特征。
[helloVoxel_user.py]
### 为所有特征加上后缀
[helloVoxel_suffix_Vovel.py]

合并相同重采样参数定义提取的体素特征和全局特征到一个csv文件中，注意他们的列名相同，但值不同！
1.5 [merged_features.py]

-------------------------------------------------------------------------------
# 2.固定调参法（重采样后，在脚本调参，更改参数不方便；提取所有的特征；操作方便）（不推荐）
# 2.1.[helloResampling.py]重采樣，对图像和标签同时进行重采样，以确保它们在空间分辨率上一致。（关键步骤）
空间一致性、准确的特征提取、改进的分析质量。
```重采样后的图像和标签
[resampled_images](pyradiomics-master%2Fdata%2FTask02_Heart%2Fresampled_images)
[resampled_masks](pyradiomics-master%2Fdata%2FTask02_Heart%2Fresampled_masks)
```
使用重采样后的图像和标签进行如下操作。

# 2.2.2[helloFeatureClass_user.py]提取所有特征（包括所有要素类和内置的可选过滤器），但不进行重采样、归一化等操作。
使用一般要素类特征和内置的可选过滤器（如高斯拉普拉斯算子（LoG）和小波等所有特征，
enableAllFeatures()方法启用了所有可用的特征提取，包括基于原始图像、LoG滤波后的图像和小波变换后的图像的特征来对图像进行提取特征。`[helloFeatureClass.py]`仅指定了部分要素和LoG和小波处理的一阶特征，_user是升级版。
## 可以先用`[helloResampling.py]`重采样后所有的图形后，得到相同的像素间距和尺寸、相同的空间分辨率和空间方向（特别对于多模态数据），然后再采用`[helloFeatureClass_user.py]`提取所有特征.
```输入重采样后的图像和标签
[resampled_images](pyradiomics-master%2Fdata%2FTask02_Heart%2Fresampled_images)
[resampled_masks](pyradiomics-master%2Fdata%2FTask02_Heart%2Fresampled_masks)
```
```输出特征文件
[all_features_wide.csv]常用
```
[helloRadiomics.py]、[helloRadiomicsWithSettings.py]介绍了组学提取指定特征、组学运用参数提取体征的示例，我已在前面运用,可省略。

# 2.3体素特征提取[helloVoxel_user.py]
```输入重采样后的图像和标签
[resampled_images](pyradiomics-master%2Fdata%2FTask02_Heart%2Fresampled_images)
[resampled_masks](pyradiomics-master%2Fdata%2FTask02_Heart%2Fresampled_masks)
```
```[exampleVoxel_all.yaml]提取所有体素特征，但不包括shape（不适合）、force2D（3d图像应保持注释或移除。）
保存voxel特征值的文件路径= [voxelfeature_values_wide.csv]
特征图保存目录= 打不開，算球
```

[merged_features.py]合并提取的重采样后的体素特征和全局特征到一个csv文件中，去除完全重复的列和列值。
```
[merged_features_unique.csv]
```
进行特征分析....







```调整掩模边界框
错误信息中提到的 Bounding box of ROI is larger than image space 指的是，
你的感兴趣区域（ROI）的边界框在图像坐标空间中的大小超出了图像本身的大小。具体来说，
ROI的边界框范围是 (303.8555361424005, 258.18919919348264, 368.61558113098147) 到 
(340.2039408847021, 309.68277257840987, 372.6752826690674)，而图像的大小是 (512, 512, 58)。

```





```# 掩模验证
  minimumROIDimensions: 2
 # 定义：minimumROIDimensions 参数指定了ROI在图像中必须存在的最小维度数量。维度是指图像的空间方向，例如，在三维图像中，维度可以是长度、宽度和高度。
 # 举例：如果设置为2，这意味着ROI必须至少在两个空间维度上有非零的大小。这个设置用于确保ROI在至少两个方向上具有空间延伸，从而排除线性或点状的ROI。
  
  minimumROISize: 2
  # 定义：minimumROISize 参数定义了ROI在所有维度上的最小体积或大小，通常以像素数（对于二维图像）或体素数（对于三维图像）为单位。
  # 举例：如果设置为2，这意味着ROI的总体积或大小必须至少为2个像素或体素。这个设置有助于排除太小而无法提供有效特征提取的ROI。

# 使用场景
在进行特征提取时，尤其是在放射组学研究中，确定ROI的大小和维度非常重要，因为它们直接影响到能够从这些区域中提取的信息类型和质量。
过小的ROI可能不足以捕捉到有意义的生物学变异，而且在统计分析中可能会引入噪声。
通过设置这些参数，研究人员可以确保只分析那些可能提供有用和可靠信息的ROI。

# 配置这些参数
这些参数的具体值取决于研究的具体需求、图像的分辨率以及ROI的预期生物学特性。
在实际应用中，应根据具体的研究目标和图像类型来调整这些参数，以确保分析的有效性和准确性。
在PyRadiomics的配置文件或代码中设置这些参数，可以帮助自动化处理流程，确保只有符合特定标准的ROI被用于后续的特征提取和分析。
```

```CT是否归一化？
[Extract_NIfTI_image_information.py]打印出图像的基本参数信息显示：启动归一化。
最小值在 -3024.0 到 -1024.0 之间变化，而最大值则在 1451.0 到 3071.0 甚至更高（如 15214.0 和 17901.0）。 这表明图像的强度范围在不同图像之间存在显著差异，这可能是由于不同的扫描参数或扫描仪导致的。
```#归一化：启用
  normalize: true
  normalizeScale: 100  # 选择合适的 normalizeScale 值确保图像数据在进行特征提取之前处于一个统一的强度范围内。
#对于肺部 CT 图像，一个常见的做法是选择一个相对较低的 normalizeScale 值，如 100 或 200，因为这些值接近于肺组织在 HU 中的自然范围。

指定了图像强度标准化的比例因子。
图像强度标准化是一种预处理步骤，旨在将图像中的像素或体素强度值调整到一个共同的范围，
以减少不同扫描设备或扫描参数变化引起的影响，从而使得特征提取更加稳定和可比较。

当设置了 normalizeScale 参数时，PyRadiomics 会将图像中的所有像素或体素强度值线性缩放，
使得图像的强度范围被标准化到特定的数值范围内。具体来说：
normalizeScale: 100 意味着所有的像素或体素强度值将被缩放，以便图像中的强度范围落在 0 到 100 之间。
这个过程不改变图像中的强度分布模式，而是将整个分布缩放到指定的范围内。

应用场景
在进行放射组学分析时，图像来自不同的扫描仪和采用不同的扫描参数，这可能会导致图像强度值在不同样本间有很大的差异。
例如，两个相同组织的 MRI 扫描可能因为扫描参数的不同而在强度上有显著差异。
通过应用强度标准化，可以在一定程度上消除这些差异，使得从不同图像中提取的特征更加可比。
```


```3D vs. 2D特征提取
图像要求
对于MR图像，PyRadiomics可以提取大量的放射组学特征，但有几个要求和注意事项：
图像预处理：为了提高特征提取的准确性和可重复性，可能需要对MR图像进行预处理，如去噪、强度标准化、重采样等。
掩模（标签）图像：需要有与MR图像对应的掩模图像，以指示感兴趣区域（ROI）。掩模图像应该是二值图像，
              其中ROI被标记为特定的标签值（如上述配置中的 label: 1）。
图像和掩模的对齐：MR图像和对应的掩模图像必须在空间上对齐，即它们具有相同的维度和物理空间定位。
3D vs. 2D特征提取：根据您的研究需求，您可以选择进行3D特征提取或通过设置 force2D: true 进行2D特征提取。
                 对于MR图像，这取决于图像的采集方式（例如，体积成像vs.平面成像）和您的分析目标。
```

```'label': 1
'label': 1：这意味着算法将只考虑标签图像中标签值为1的区域作为感兴趣区域进行特征提取。这是一种常见的约定，因为在二值掩模中，0通常代表背景，而1代表目标区域。
在进行医学图像的特征提取时，明确指定哪个标签值代表你的感兴趣区域是很重要的。这确保了算法只分析和计算指定区域的特征，
从而提高了分析的准确性和相关性。如果你的掩模图像只包含一个感兴趣的区域，并且这个区域的标签值为1，
那么指定'label': 1是有意义的。如果你有多个区域或使用不同的标签值，你需要相应地调整这个参数。
```

```LoG（Laplacian of Gaussian）特征和小波特征
LoG（Laplacian of Gaussian）特征和小波特征是从图像中提取信息的高级方法，它们不仅限于一阶特征，而是可以用于提取多种类型的特征，包括形状、纹理等。
这些方法通过在不同的尺度和方向上分析图像，增强了特征提取的能力，使得从图像中获得的信息更加丰富和多维。

LoG特征：
LoG特征是通过先对图像应用高斯滤波平滑，然后计算其拉普拉斯算子（二阶导数）来提取的。这种方法特别适合于强调图像中的边缘信息，
因为拉普拉斯算子对图像的边缘敏感。通过改变高斯滤波的标准差（σ），可以在不同的尺度上检测边缘和纹理，
这使得LoG特别适合于分析具有不同尺寸size和形状shape特征的图像。

小波特征：
小波变换提供了一种在多个尺度上分析图像的方法。它通过将图像分解为一系列具有不同分辨率的子图像来工作，每个子图像捕获图像的不同频率成分。
这种方法允许同时分析图像的局部和全局特征，使得小波特征非常适合于纹理分析（如GLCM、GLDM特征）和图像分割Image segmentation。

应用
LoG和小波特征在医学图像分析中尤其有用，例如在"肿瘤特征化"、"组织分类"和"病变检测"中。它们可以帮助识别图像中的微妙模式，
这些模式可能对疾病的诊断和预后至关重要。
这些特征不仅限于一阶特征。例如，除了计算一阶统计量（如均值、方差等）之外，
还可以在LoG或小波变换后的图像上计算二阶纹理特征（如GLCM特征）、形状shape特征等。
在机器学习和深度学习应用中，LoG和小波特征可以作为特征工程的一部分，以"提高模型的性能和泛化能力"。
总之，LoG和小波特征通过提供从不同尺度和角度分析图像的能力，增强了图像分析的深度和广度。这些方法的应用不限于一阶特征，
而是可以广泛应用于多种特征类型的提取，为图像分析提供了强大的工具。

sigma值：
3mmMR：sigma: [2.0, 3.0, 4.0, 5.0] #由于重采样为(2, 2, 2)，不建议使用 <2 mm 的 sigma。
5mmMR: sigma: [3.0, 5.0]  # 由于重采样为（3, 3, 3），不推荐使用小于3mm的sigma值。
是LoG操作中用于高斯平滑的标准差参数的列表。
较小的sigma值会导致较小的平滑效果，而较大的sigma值会导致更大的平滑效果。
该注释中还提到了一个重要的注意事项：如果你使用了大于5的sigma值，那么在设置sigma参数时，要同时考虑增加padDistance。
padDistance是用于在图像边界周围增加填充的距离，以确保LoG操作可以正确应用到整个图像上，而不会受到边界效应的影响。
因此，当使用较大的sigma值时，可能需要增加padDistance参数的值，以确保LoG操作的准确性和稳定性。
```

```重采样
通常涉及将图像从一个空间坐标系转换到另一个空间坐标系，并重新定义图像中的像素值以匹配新的像素间距和图像尺寸。

重采样的主要意义包括：
标准化图像尺寸和像素间距： 不同的医学图像可能具有不同的像素间距和尺寸，这会导致在图像分析和处理中的不一致性。通过重采样，
                      可以将所有图像调整到相同的像素间距和尺寸，从而实现标准化和一致性。
提高图像质量和分辨率： 有时候，医学图像可能具有较大的像素间距或较低的分辨率，这可能会降低图像的质量和可视化效果。
                   通过重采样，可以增加图像的分辨率，使得图像更加清晰和详细。
配准不同空间图像： 当需要将不同模态的医学图像（如MRI、CT等）进行配准时，需要将它们统一到相同的空间坐标系中。
                重采样可以实现这一目的，使得不同图像具有相同的空间分辨率和空间方向。
减少计算复杂度： 在某些情况下，处理高分辨率图像可能会导致计算复杂度过高。通过重采样将图像转换为较低分辨率，可以减少计算复杂度，提高算法的效率。

resampledImageSpaceing=[2, 2, 2]: 
指定了重采样后的图像空间分辨率。在这里，[2, 2, 2]表示重采样后的图像每个方向上的像素间距分别为2mm。这可以影响图像在物理空间中的尺寸和形状。
label=1: 
指定了要使用的标签值，用于定义边界框。在这里，标签值为1表示掩码图像中用于定义感兴趣区域的像素值。重采样和裁剪操作将基于这个标签值对图像进行操作。
padDistance=5:
指定了裁剪时额外添加的填充距离。在这里，padDistance=5表示在感兴趣区域周围额外添加5个像素的填充。这样做是为了确保在裁剪操作时，
感兴趣区域的边界不会被截断，以免丢失有用信息。

MR重采样的参数
对于MR图像的重采样，resampledImageSpaceing=[2, 2, 2]参数指定了新的体素大小为2x2x2毫米。这个参数是否合适取决于您的具体需求：
分辨率：如果原始图像的分辨率远高于2毫米/体素，这样的重采样可能有助于减少数据量，同时保留足够的细节进行分析。但如果原始数据的分辨率接近或低于2毫米/体素，这样的重采样可能会导致细节损失。
一致性：在多个图像上进行特征提取时，使用相同的重采样参数可以确保特征计算的一致性。
分析目的：根据您的分析目标，您可能需要调整重采样参数以优化性能和结果的准确性。
padDistance
padDistance=5参数指定了在裁剪图像时围绕ROI添加的边界大小（以毫米为单位）。这有助于确保ROI周围有足够的上下文信息。这个参数的选择取决于您的分析需求和ROI的大小。
```

```
在你提供的代码和上下文中，重采样的图像只有一个并不意味着图像和标签（掩码）被合并了。实际上，imageoperations.resampleImage 函数是
用于调整图像的空间分辨率，使其与另一个图像（通常是标签或掩码图像）的空间分辨率一致。这个过程不会合并图像和标签数据；它仅仅改变了图像的采样率以匹配掩码的空间格局。

在医学影像处理中，重采样是一种常见的预处理步骤，用于确保图像和其对应的掩码（或称为标签图像）具有相同的空间分辨率和维度。
这是因为在进行图像分析（如放射组学特征提取）时，需要确保图像和掩码完全对齐，以便于从特定区域（由掩码定义）准确提取特征。

在你的代码中，resampleImage 函数用于重采样图像，使其具有与掩码相同的空间分辨率。
这个函数的目的是为了调整图像的采样率，而不是将图像和掩码合并。输出的“重采样图像”是经过空间分辨率调整后的图像，而掩码文件仍然保持不变。

以下是这个过程的简化说明：
读取图像和掩码：使用 sitk.ReadImage 分别读取图像文件和对应的掩码文件。

重采样图像：调用 imageoperations.resampleImage 函数，传入图像和掩码
。这个步骤调整了图像的空间分辨率，使其与掩码的分辨率相匹配。此函数通常不会修改掩码；它主要修改图像。

保存重采样后的图像：使用 sitk.WriteImage 保存调整后的图像到指定的输出路径。这一步骤不涉及掩码的保存，因为掩码未经修改。

因此，重采样过程只涉及对原始图像的空间分辨率调整，而不会改变掩码文件或将图像和掩码合并。如果你需要同时处理图像和掩码，
比如确保它们都被重采样到相同的分辨率，你需要分别对它们执行重采样操作，并根据需要分别保存它们。
```



