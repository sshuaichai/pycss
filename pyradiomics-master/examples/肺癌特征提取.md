# 研究思路：GPT插件生成訓練、解釋的代碼 （全面但不準確）；  Python用來更正更完美的代碼（準確但不全面）。
将`分类模型的输出`用于`生存分析`是一个可行的方法，尤其是在处理有关`时间到事件（如疾病复发、机器故障等）`数据的研究中。这种方法通常包括以下几个步骤：
`建立分类模型`：首先，你需要建立一个分类模型来预测个体的某个特定结果，如疾病的有无、事件的发生与否等。
这个模型可以是逻辑回归、随机森林、神经网络或任何其他适合你数据的模型。

`计算预测概率`：模型建立后，你可以用它来计算每个个体发生特定事件的概率。
这个概率值通常在0到1之间，可以视为个体属于正类（事件发生）的可能性。

`确定截断值（cutoff value）`：接下来，你需要确定一个截断值来将个体分为高风险和低风险两组。
截断值的选择可以基于特定的临床需求、成本效益分析或模型的ROC曲线（接收者操作特征曲线）。
通常，这个值需要通过一系列的分析来确定，目的是找到最佳平衡点，最大化模型的敏感性和特异性。

`进行生存分析`：一旦确定了截断值，并据此将个体分组，就可以使用生存分析方法（如Kaplan-Meier曲线、Cox比例风险模型等）来比较不同组别的生存情况。
这样，你可以评估不同风险等级个体之间在生存时间上是否存在显著差异。

这种方法的优点是能够`结合机器学习模型的预测能力`和`生存分析的统计方法`，为决策提供更丰富的信息。
然而，选择适当的截断值是一个关键步骤，因为它直接影响到分组的准确性和随后分析的结果。在实际应用中，可能需要考虑多种因素，并可能需要基于特定的应用场景进行细致的调整。
==============================================
特征数目
数量变化：每次提取的特征数目不一定相同，这取决于选择的特征类别、提取方法、影像类型（如CT、MRI）、以及区域的大小和形状。通常，一个全面的影像组学分析可能提取几十到几百个不同的特征。
提取的特征类型
`形状特征`（Shape Features）：描述肿瘤或感兴趣区域（ROI）的几何形状和大小，如体积、表面积、最大直径、椭圆形拟合参数等。

`一阶统计特征`（First-order Statistics）：描述图像强度分布的统计参数，如平均强度、标准差、偏斜度、峰度等。

`纹理特征`（Texture Features）：通过分析图像灰度的空间分布来量化图像纹理的粗糙度或规律性。常用的纹理特征包括灰度共生矩阵（GLCM）、灰度等级大小区域矩阵（GLRLM）、灰度等级依赖矩阵（GLDM）和灰度距离差矩阵（GDDM）等。

`高阶特征`（Higher-order Features）：通常通过应用一些数学变换（如`小波变换、Gabor滤波、拉普拉斯变换`等）得到，可以提供关于图像模式的更深层次信息。
可视化：10、22、35、70、87、101、105、114、131
===============================================
# 开始
1.首先转换数据集为nii.gz格式，并将数据保存到[Dataset019_Lung](..%2F data %2F Dataset019_Lung)

[helloResampling_before.py]看看是否需要重新提取label，即label划到图像外面去了：
10、11、12

2. 图像重采样[helloResampling.py]
保存重采样图像到原图像目录下，然后对吧重采样的图像和没有重采样的图像分别放在一个文件夹内。
无重采样：
`[Dataset021_Lung]`
重采样的图像命名为'_name+1_...'：
`[Dataset022_Lung] ` resampledPixelSpacing=[1, 1, 1]

2.使用bin的[GenerateInputCSV_Filename_22.py]生成CT数据的csv文件
`[Dataset022_Lung.csv]`

3.参数解释：
[Extract_NIfTI_image_information.py]打印出图像的基本参数信息显示：启动归一化。
最小值在 -3024.0 到 -1024.0 之间变化，而最大值则在 1451.0 到 3071.0 甚至更高（如 15214.0 和 17901.0）。 这表明图像的强度范围在不同图像之间存在显著差异，这可能是由于不同的扫描参数或扫描仪导致的。
```#归一化：启用
  normalize: true
  normalizeScale: 100  # 选择合适的 normalizeScale 值确保图像数据在进行特征提取之前处于一个统一的强度范围内。
#对于肺部 CT 图像，一个常见的做法是选择一个相对较低的 normalizeScale 值，如 100 或 200，因为这些值接近于肺组织在 HU 中的自然范围。
```

4.1提取全局特征
[batchprocessing_Overall.py]   binWidth: 25
`radiomics_features_filter.csv`文件。
```[Calculated_quantity_class.py]  提取重采样的图像，因为要统一图像分辨率
# 有重采样：
[radiomics_022_features_filter.csv] : 最后提取141个病人
Feature Category,Count
diagnostics,22
original,107 （原始）
log-sigma-1-0-mm-3D,93 （滤波）
log-sigma-2-0-mm-3D,93
log-sigma-3-0-mm-3D,93
log-sigma-4-0-mm-3D,93
log-sigma-5-0-mm-3D,93
wavelet-LLH,93
wavelet-LHL,93
wavelet-LHH,93
wavelet-HLL,93
wavelet-HLH,93
wavelet-HHL,93
wavelet-HHH,93
wavelet-LLL,93
Total number of features: 1338
=======
Feature Category, Count (原始+滤波)
firstorder: 252
shape: 14
glcm: 336
glrlm: 224
glszm: 224
gldm: 196
ngtdm: 70
Total: 1316
```
```提取特征时，最终得到的特征图像数量可能少于原始图像数量的原因有多个，这里列出一些常见的情况：
感兴趣区域（ROI）的缺失或排除：如果某些图像中没有定义感兴趣区域（ROI），或者ROI太小而被排除，那么这些图像在特征提取过程中可能会被忽略。
图像质量问题：低质量的图像，如那些过于模糊或有太多噪声的图像，可能在预处理或特征提取阶段被排除，以确保最终结果的质量。
预处理步骤：在特征提取之前，图像通常会经过一系列预处理步骤，如去噪、标准化、重采样等。这些步骤可能会导致某些图像因不满足特定条件而被排除。
技术限制或错误：软件实现的特定限制或错误也可能导致某些图像在特征提取过程中被意外排除。例如，软件可能无法处理特定格式的图像文件，或者在处理过程中遇到错误而停止。
特定的筛选标准：在某些情况下，研究者可能基于特定的临床或研究标准选择性地只对某些图像进行特征提取，比如只分析特定类型的病变或特定阶段的疾病图像。
计算资源限制：在资源受限的情况下，可能会有意选择只处理一部分图像集，以减少计算时间和资源消耗。
```
4.2提取体素特征（需要重采样） ： 探究肿瘤栖息地
### 注意：在进行提取之前首先对图像进行重采样：[helloResampling.py]，这里使用和全局特征相同的重采样：resampledPixelSpacing: [1, 1, 1] 
[exampleVoxel_R3B12.yaml]： kernelRadius: 3  核半径  binWidth: 12
```[Calculated_quantity_Voxel_class.py]
计算excel中提取的特征数量
R1B12:
Feature Category,Count
diagnostics,19
original,107
Image,1
Total number of features: 127
===========
Feature Category, Count
firstorder: 18
shape: 14
glcm: 24
glrlm: 16
glszm: 16
gldm: 14
ngtdm: 5
Total: 107                              
```

4.3 合并提取 : [suffix_Voxel.py]：
"D:\zhuomian\pyradiomics\pyradiomics-master\examples\output\final\radiomics_R3B12_features.csv"
`[radiomics_R3B12_features.csv]`
```组学+体素特征
Feature Category,Count
diagnostics,44
original,214
log-sigma-1-0-mm-3D,93
log-sigma-2-0-mm-3D,93
log-sigma-3-0-mm-3D,93
log-sigma-4-0-mm-3D,93
log-sigma-5-0-mm-3D,93
wavelet-LLH,93
wavelet-LHL,93
wavelet-LHH,93
wavelet-HLL,93
wavelet-HLH,93
wavelet-HHL,93
wavelet-HHH,93
wavelet-LLL,93
Total number of features: 1467
====
Feature Category, Count
firstorder: 270
shape: 28
glcm: 360
glrlm: 240
glszm: 240
gldm: 210
ngtdm: 75
Total: 1423
```

5.建立模型：
将筛选后的临床特征和影像特征融合建立一个模型，与分别建立两个模型再融合这两个模型的效果好坏，取决于多个因素，
包括数据的性质、模型的复杂度、以及最终应用的具体需求。下面是两种方法的优缺点，以及在何种情况下选择它们可能更合适。
# 分别建立模型后融合
优点：
专门化模型：针对不同类型的数据（如临床数据和影像数据）建立专门的模型，可以允许使用最适合该类型数据的算法和参数，可能提高模型的性能。
灵活性和可解释性：分别对不同的数据源建模可以提高模型的可解释性，因为你可以单独评估每个模型的性能。此外，这种方法提供了更大的灵活性，
可以单独更新或改进模型中的一个部分。
缺点：
集成复杂性：需要额外的步骤来集成多个模型的输出，这可能包括调整不同模型的权重，以及处理可能出现的过拟合问题。
计算成本：运行多个模型可能会增加计算成本和时间，特别是在大规模数据集上。

## 5.1 首先加入終点事件
125、92-95、30缺乏重点事件

## 提取IMAGE列中的数值赋值为ID，手动加入time、event列：
[final_022_addID.csv.csv]

## 預處理后...

## 划分数据集
[Data_set_partition.py]为3组：
1.训练集：用于训练
2.验证集：多次验证调成参数
3.测试集：最后的最后再使用

1.训练

2.关于特征选择方法的选择：
没有一种`特征选择方法`是适用于所有情况的。`Lasso`（L1正则化）是一种很好的特征选择方法，因为它倾向于产生稀疏解， 即将不重要的特征的系数压缩到0。然後通过交叉验证评估不同模型的性能。

对于139个病人的数据集，使用交叉验证是合适的，因为它可以最大化利用有限的数据。您选择的模型和评分指标也很合适，可以全面评估模型的性能。只要确保数据预处理（如编码和标准化）正确无误，这段代码应该能够给您提供关于哪种模型最适合您数据的有用信息。

3. 进一步的步骤
`模型融合`：如果您计划融合多个模型的预测结果来提高性能，可以考虑使用简单的投票机制、堆叠（stacking）等策略。
`超参数调优`：考虑使用GridSearchCV或RandomizedSearchCV对关键模型进行超参数调优，以进一步提高模型性能。
`模型解释性`：探索模型的解释性，比如使用`SHAP值`、`特征重要性`等，来理解模型的决策依据。

4.截断值的确定和高低危组的分割：

特征选择和基于放射组学的模型构建我们开发了基于放射组学的模型，用于预测训练队列中的隐匿性肝转移，分别通过以下步骤：
```Development of a radiomics-based model to predict occult liver metastases of pancreatic ductal adenocarcinoma: a multicenter study
（i）每个特征通过 Z 分数标准化； 
(ii) 估计每对特征的皮尔逊相关系数（PCC），以消除共线性特征，阈值为0.99； 
(iii) 使用方差分析（ANOVA）来选择候选特征； 
(iv) 使用具有 5重交叉验证的lasso-logistic归回来构建基于放射组学的模型。
```


一旦您选择了最佳模型并使用训练集对其进行了训练，您可以通过`在验证集上评估模型`来确定`最佳的截断值`。这通常涉及到`分析ROC曲线`，找到`最优化特定性能指标（如F1分数）的阈值`。确定截断值后，您可以使用这个阈值将患者分为高危和低危两组。
`Rad-Score`定义为基于放射组学的模型的预测概率，通过`训练队列中Youden指数`对应的`最佳截断值`对`连续Rad-Score进行二值化`，
将患者分为`高危组`和`低危组`风险亚组。
[计算Cutoff值.md]

相同的截止值`也适用于验证队列`。进行`单变量`和`多变量Cox回归`来探讨其预后预测价值。
然后，使用对数秩检验比较训练、内部验证和外部验证队列中高风险或低风险亚组的 PFS 和 OS。


此外，探讨基于放射组学的模型在高风险和低风险亚组患者之间的病理肿瘤、淋巴结、转移（TNM）分期、PFS和OS的 风险分层中的互补价值每个 TNM 阶段。



