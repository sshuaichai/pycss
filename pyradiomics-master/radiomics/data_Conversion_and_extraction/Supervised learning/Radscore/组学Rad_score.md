从您提供的输出来看，display_and_save_formula函数已经正确执行，但由于您使用的模型在Pipeline中没有coef_属性，因此无法显示和保存公式。
这表明您可能使用的`是非线性模型`（如`随机森林、梯度提升树、支持向量机`等），这些模型的决策过程不能简单地通过线性方程来表示。

对于这种情况，您可能需要考虑其他方式来解释或展示模型的决策逻辑，例如：

特征重要性：对于`树形模型`（如`随机森林、梯度提升树`等），可以使用模型的feature_importances_属性来获取特征的重要性。
这可以帮助您理解哪些特征对模型的预测结果影响最大。
模型可视化：对于决策树模型，可以直接可视化树的结构来理解模型的决策过程。
SHAP值：SHAP（SHapley Additive exPlanations）是一种解释模型预测的方法，适用于各种类型的模型。
它可以帮助您理解每个特征对模型预测结果的贡献。

---------------------------
## 假设您已经有一个合并了所有数据集的大DataFrame，并且其中包含一个名为dataset_type的列，用于区分数据来自训练集、内部验证集还是外部验证集。

```angular2html
Cox回归分析的二元事件变量=event（事件发生的指示， 通常是1表示事件发生，0表示未发生，例如死亡或疾病复发） 以及其他需要包含在Cox回归分析中的列。
注意事项:
 在使用Cox回归分析之前，确保您的数据集中包含了event列，该列指示了每位患者的生存状态（例如，是否发生了感兴趣的事件，如死亡或复发）。
 在进行对数秩检验和绘制Kaplan-Meier生存曲线之前，您需要根据最佳阈值将患者分为`高危`和`低危`两组，并确保`每组中都有pfs和event数据`。
 上述代码示例假设您已经根据最佳阈值将features_df中的患者分为了高危和低危两组，并且features_df中包含了pfs和event列。
 通过添加这些分析步骤，您可以更全面地评估Rad评分的预后预测价值，并通过生存曲线直观地展示不同风险组患者的生存概率差异。
```
![img_1.png](img_1.png)

---------------------------------

基于您的描述，Rad-Score是一种基于放射组学特征的预测模型输出，用于预后风险评估。
以下是使用该方法进行预后预测价值探讨的步骤概述，包括单变量和多变量Cox回归分析以及对数秩检验的应用：

加载数据集：

分别加载训练集、内部验证集和外部验证集。
为每个数据集添加一个新列（dataset_type），以标识数据属于哪个集合（训练、内部验证、外部验证）。 将这些数据集合并成一个大的DataFrame。
 加载模型：加载您之前训练好的模型，用于后续计算Rad-Score。
 设置全局样式：为了确保图表的一致性和美观，设置全局的绘图样式。
 计算Rad-Score：使用加载的模型对合并后的DataFrame中的每个样本计算预测概率（即Rad-Score）。
 寻找最佳阈值：仅在训练集上通过ROC曲线分析计算Youden指数，找到最佳截断值（阈值），以最大化敏感性和特异性之和。
 分类风险组：使用在训练集上找到的最佳阈值，将合并后DataFrame中的所有样本根据Rad-Score分为高危和低危两组。
 执行并可视化生存分析：对每个数据集类型（训练、内部验证、外部验证）执行生存分析，包括Cox回归分析和Kaplan-Meier生存曲线绘制。将分析结果（Cox回归图和Kaplan-Meier曲线图）保存到指定的路径。
 结果保存路径：确保结果保存路径存在，如果不存在则创建。
 对每个数据集类型执行生存分析并可视化：遍历每个数据集类型（训练、内部验证、外部验证），执行并可视化生存分析，包括单变量和多变量Cox回归分析，以及对数秩检验比较高危组和低危组的PFS差异。

# `C指数（Concordance index，通常缩写为C-index`）是用于评估预测模型预测准确度的一种统计指标。
在生存分析中，C指数通常用于`评估风险预测模型（例如生存分析模型）的性能`。它衡量了模型对于两个随机选取的样本，模型能够正确地判断哪个样本的风险更高的概率。
C指数的取值范围在0.5到1之间，其中0.5表示模型的预测效果等同于随机猜测，1表示完美的预测能力。

# `校准曲线`是在机器学习和统计建模中用来`评估分类器（或者其他预测模型）`的一种图形化方法。
`它展示了模型预测的概率与实际观测到的概率之间的关系`。如果一个模型是完美校准的，那么校准曲线将与45度对角线重合。
在实际情况下，校准曲线可能会偏离45度对角线，这表明模型的预测存在偏差。通过观察校准曲线，可以评估模型的预测准确性以及是否需要进行校准调整来改善模型性能。

```
在你提供的代码中，时间单位（天、月、年等）并没有直接在代码本身中被明确指定。
实际上，生存分析中的时间单位是根据你的数据集中pfs列的数值来隐式确定的。
如果你提到pfs的单位是天，那么这个信息是来自于你对数据集的理解或数据集的文档说明，而不是直接从代码中体现出来的。
生存分析的函数和方法（如CoxPHFitter.fit和KaplanMeierFitter.fit）处理时间数据时，它们并不需要知道时间的具体单位，只需要时间数据的数值。
时间单位的理解和解释由分析者基于对数据集的理解来确定。
因此，如果你的pfs数据是以天为单位记录的（例如，如果pfs值为90，那么意味着90天），
那么所有基于这些数据的分析结果（包括生存曲线、风险比例等）自然也是以天为单位的。
这个单位的理解对于解释模型结果（如生存时间、风险比率等）至关重要，
但它不是通过代码直接指定的，而是基于你对数据的理解和文档说明。
```
======================
[Radscore_tiaoshi.py]调试最佳阈值：
5折 100轮：Final Best Threshold: 0.6898347027357027, Average P-Value: 0.0000000000015375
5折 300轮：Final Best Threshold: 0.6853500782775832, Average P-Value: 0.0000000000015375
5折 500轮：Final Best Threshold: 0.29998997995991983, Average P-Value: 0.0000000036434976
    1000: Final Best Threshold: 0.6714766133638859, Average P-Value: 0.0000000000000270

6折 100轮：Final Best Threshold: 0.7030494905575168, Average P-Value: 0.0000000000001951
6折 300轮：Final Best Threshold: 0.6984756306962384, Average P-Value: 0.0000000000001951
6折 500轮：Final Best Threshold: 0.698736002572542, Average P-Value: 0.0000000000001951

7折 100轮：Final Best Threshold: 0.3027561327561327, Average P-Value: 0.0000000050807548
7折 300轮：Final Best Threshold: 0.6965749256403069, Average P-Value: 0.0000000000001460
7折 500轮：Final Best Threshold: 0.6969211317908821, Average P-Value: 0.0000000000001460

8折 100轮：Final Best Threshold: 0.30287878787878786, Average P-Value: 0.0000000036434976
8折 300轮：Final Best Threshold: 0.3004682274247491, Average P-Value: 0.0000000036434976
8折 500轮：Final Best Threshold: 0.29998997995991983, Average P-Value: 0.0000000036434976
    1000: Final Best Threshold: 0.6714766133638859, Average P-Value: 0.0000000000000270

9折 100轮：Final Best Threshold: 0.30297418630751966, Average P-Value: 0.0000000034836998
9折 300轮：Final Best Threshold: 0.3004682274247491, Average P-Value: 0.0000000036434976
9折 500轮：Final Best Threshold: 0.6911925062285573, Average P-Value: 0.0000000000000393

10折 100轮 ：Final Best Threshold: 0.30305050505050507, Average P-Value: 0.0000000023122650
10折 300轮 ：Final Best Threshold: 0.3004682274247491, Average P-Value: 0.0000000036434976
10折 500轮： Final Best Threshold: 0.29998997995991983, Average P-Value: 0.0000000036434976
            Final Best Threshold: 0.2988400900900901, Average P-Value: 0.0000000036434976


选择最佳阈值时，我们通常考虑两个主要因素：平均p值和阈值的稳定性。在您提供的结果中，所有的平均p值都非常小，远小于常用的显著性水平（如0.05），这表明不同风险组之间的生存时间差异是非常显著的。因此，从统计显著性的角度看，所有这些阈值都是可接受的。
阈值的稳定性：在不同的交叉验证折数和轮数下，阈值应该相对稳定。阈值的波动越小，说明模型在不同的数据子集上更加稳健。
临床可解释性和实用性：最佳阈值应该在临床上有意义，能够为医生提供直观且实用的风险分层依据。
交叉验证的折数：更高的折数意味着模型在更小的训练集上进行训练，这可能会增加模型的泛化能力，但同时也可能增加模型的不稳定性。通常，5折到10折的交叉验证被广泛认为是一个好的平衡点。

从您提供的数据来看，随着交叉验证折数的增加，平均p值有所下降，这表明模型在更细分的数据集上可能表现得更好。然而，从5折到10折，最佳阈值在0.67到0.70之间波动。
综合考虑，`8折交叉验证在300轮`时给出的阈值（0.6713965017719157）具有最小的平均p值（0.0000000000000270），这表明在这个设置下模型的分组差异最为显著。尽管如此，选择最佳阈值还应考虑上述提到的其他因素，特别是阈值的稳定性和临床实用性。
在实际应用中，建议与临床专家合作，考虑阈值的临床意义，同时也可能需要考虑模型在独立测试集上的表现，以进一步验证所选阈值的泛化能力和实用性。




